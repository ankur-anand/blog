<!DOCTYPE html><html class="light page-post"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>Terrible performance cost of cors request on single page application(spa) | Ankur Anand</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><link rel="canonical" href="http://blog.ankuranand.com/2018/09/02/the-terrible-performance-cost-of-cors-api-on-the-single-page-application-spa/"><meta name="title" content="Terrible performance cost of cors request on single page application(spa)"><meta name="referrer" content="unsafe-url"><meta name="author" content="Ankur Anand"><meta name="keywords" content="JavaScript,spa,cors,performance,"><meta name="description" content="IntroductionThe title may lead you to think that this post is another ranting post about the downside of a “Single Page Application”. It is more about shedding some light on the performance perspectiv"><meta name="keywords" content="JavaScript,spa,cors,performance"><meta property="og:type" content="article"><meta property="og:title" content="Terrible performance cost of cors request on single page application(spa)"><meta property="og:url" content="http://blog.ankuranand.com/2018/09/02/the-terrible-performance-cost-of-cors-api-on-the-single-page-application-spa/"><meta property="og:site_name" content="Ankur Anand"><meta property="og:description" content="IntroductionThe title may lead you to think that this post is another ranting post about the downside of a “Single Page Application”. It is more about shedding some light on the performance perspectiv"><meta property="og:locale" content="en"><meta property="og:image" content="https://cdn-images-1.medium.com/max/2000/1*AMwfAiyXXDQ0XGBmLCppYg.png"><meta property="og:image" content="https://cdn-images-1.medium.com/max/2476/1*sTyYs_f5qGpMYk16Mb7yZQ.png"><meta property="og:image" content="https://cdn-images-1.medium.com/max/2436/1*aIMIcGkZGOuYJXug_6oCww.png"><meta property="og:updated_time" content="2019-06-09T14:07:03.641Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Terrible performance cost of cors request on single page application(spa)"><meta name="twitter:description" content="IntroductionThe title may lead you to think that this post is another ranting post about the downside of a “Single Page Application”. It is more about shedding some light on the performance perspectiv"><meta name="twitter:image" content="https://cdn-images-1.medium.com/max/2000/1*AMwfAiyXXDQ0XGBmLCppYg.png"><meta name="twitter:creator" content="@in_aanand"><meta property="article:author" content="https://ankuranand.com/"><meta name="robots" content="index, follow"><link rel="icon" href="/images/favicon.png"><link href="/css/styles.css?v=c114cbeddx" rel="stylesheet"><link rel="stylesheet" href="/css/personal-style.css"><script type="text/javascript">!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script"),ga("create","UA-76643336-2","auto"),ga("send","pageview")</script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css"></head></html><body><span id="toolbox-mobile" class="toolbox-mobile">Blog</span><div class="post-header CENTER"><div class="toolbox"><a class="toolbox-entry" href="/"><span class="toolbox-entry-text">Blog</span> <i class="icon-angle-down"></i> <i class="icon-home"></i></a><ul class="list-toolbox"><li class="item-toolbox"><a class="CIRCLE" href="https://ankuranand.com" rel="noopener noreferrer" target="_self">About</a></li><li class="item-toolbox"><a class="CIRCLE" href="/atom.xml" rel="noopener noreferrer" target="_blank">RSS</a></li><li class="item-toolbox"><a class="CIRCLE" href="/search/" rel="noopener noreferrer" target="_self">Search</a></li></ul></div></div><div class="content content-post CENTER"><article id="post-the-terrible-performance-cost-of-cors-api-on-the-single-page-application-spa" class="article article-type-post" itemprop="blogPost"><header class="article-header"><h1 class="post-title">Terrible performance cost of cors request on single page application(spa)</h1><div class="article-meta"><span><i class="icon-calendar"></i> <span>2018.09.02</span> </span><span class="article-author"><i class="icon-user"></i> <span>Ankur Anand</span> </span><span class="article-category"><i class="icon-list"></i> <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a></span></div></header><div class="article-content"><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>The title may lead you to think that this post is another ranting post about the downside of a “Single Page Application”. It is more about shedding some light on the <em>performance perspective to keep in mind while designing the SPA. </em>Especially if<em> </em>your<em> </em>SPA consumes APIs from different domain services.</p><p>If you are designing an SPA which consumes the API from the same domain of the SPA, then great. You should skip this article if your SPA only pulls from the API on the same domain.</p><h2 id="Cost"><a href="#Cost" class="headerlink" title="Cost"></a>Cost</h2><p>Most SPAs involve “microservices.” They consume different endpoints of services serving by different domains within the SPA. This adds resilience, fault tolerance, and an improved user experience of our product. Multiple domain requests become inevitable until and unless we strictly adhere to the same domain app <strong>API Gateway — Microservices Pattern</strong> for our SPA.</p><p><img src="https://cdn-images-1.medium.com/max/2000/1*AMwfAiyXXDQ0XGBmLCppYg.png" alt="SPA + Cors does not always reduce the latency."><em>SPA + Cors does not always reduce the latency.</em></p><p>Let’s Imagine we have a <code>GET API /users/report/:id</code> served from domain <code>api.example.com</code>. Our SPA is served from spa.example.com. <strong>The :id means its a value that can change for every request</strong>.</p><p>Can you guess the issue with the above API design with respect to <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener">CORS</a> (Cross-Origin Resource Sharing) and its impact on the performance of our SPA?</p><p>Here’s a brief Introduction of CORS from <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" rel="noopener">MDN</a>:</p><p><img src="https://cdn-images-1.medium.com/max/2476/1*sTyYs_f5qGpMYk16Mb7yZQ.png" alt></p><p>CORS is all good while it’s a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#Simple_requests" target="_blank" rel="noopener">simple request</a> that doesn’t trigger a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#Preflighted_requests" target="_blank" rel="noopener">CORS </a>preflight. But most often we make requests that are not a “ <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#Simple_requests" target="_blank" rel="noopener">simple request</a>.”</p><p>This is due to the fact that we need to send a header that is not <a href="https://fetch.spec.whatwg.org/#cors-safelisted-request-header" target="_blank" rel="noopener">CORS-safelisted-request-header</a>. An example header is Authorization, x-corelation-id. Frequently our Content-Type header value is application/json. This is not an allowed value for the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type" target="_blank" rel="noopener">Content-Type</a> header for <a href="https://fetch.spec.whatwg.org/#cors-safelisted-request-header" target="_blank" rel="noopener">cors-safelisted-request-header</a>.</p><p>If our api.example.com server accepts content-type of application/json, our SPA domain spa.example.com will first send an HTTP request by the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/OPTIONS" target="_blank" rel="noopener">OPTIONS</a> method. It is sent to the resource <code>/users/report/12345</code> on the other domain api.example.com. To determine whether the actual request is safe to send, the option is sent preflighted. Cross-site requests are always preflighted like this, since they may have implications for user data.</p><p>It’s the job of api.example.com server to let the other domain spa.example.com know it’s safe to send the data. You might have done something similar to this for CORS inside your Application.</p><p><img src="https://cdn-images-1.medium.com/max/2436/1*aIMIcGkZGOuYJXug_6oCww.png" alt="Allowing CORS on Express.js Server"><em>Allowing CORS on Express.js Server</em></p><p>Once the api.example.com server sends the proper response from “OPTIONS” method to other domain spa.example.com then only the actual data with the request you were trying to make is done.</p><blockquote><p><em>So to access a resource api.example.com/users/report/12345 <strong>two actual requests were performed.</strong></em></p></blockquote><p>You might say yes. We can use the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS#Preflighted_requests#Access-Control-Max-Age" target="_blank" rel="noopener">Access-Control-Max-Age header </a>to cache the results of a preflight request. The next time we access the resource api.example.com/users/report/12345 from spa.example.com there is no preflight request.</p><p>Yes, that’s true, but then remember the title — The terrible performance cost of <strong>CORS </strong>requests on the single-page application (SPA). This comes from the API that we’re are consuming and the way it’s been designed. In our example, we designed our API <code>/users/report/:id</code>, where <code>:id</code> means its a value that can change.</p><blockquote><p><em>The way preflight cache works is per URL, not just the origin. This means that any change in the path (which includes query parameters) warrants another preflight request.</em></p></blockquote><p><strong>So in our case, to access resource api.example.com/users/report/12345 and api.example.com/users/report/123987, it will trigger four requests from our SPA in total.</strong></p><p>If you have a slow network, this could be a huge setback. Especially when an OPTIONS request takes 2 seconds to respond, and another 2 for the data.</p><p><strong>Now imagine your SPA application making millions of such requests for different domains. </strong>It will have a terrible impact on your SPA’s performance. You’re doubling the latency of every request.</p><blockquote><p><em>SPAs are great in their own domain. But for consuming different domains they come with their own cost. If the API is poorly designed, the latency issues of your SPA can hurt more than the benefits they provide.</em></p></blockquote><p>There is no solution or technology that is wholly good or bad. Knowing its shortcoming and what it takes to make it work are what matters. This is what differentiates your Application from the others.</p><p class="article-content share_center"><strong>Learned something? Share 👏 to help others find this article.</strong></p><div class="share share_center"><ul class="share__list"><li class="share__item"><a href="https://twitter.com/share?text=Terrible performance cost of cors request on single page application(spa)&amp;url=http://blog.ankuranand.com/2018/09/02/the-terrible-performance-cost-of-cors-api-on-the-single-page-application-spa/index.html&amp;via=in_aanand" target="_blank"><svg class="icon share__icon share__icon--twitter"><use xlink:href="#icon-twitter" xmlns:xlink="https://www.w3.org/1999/xlink"/></svg> Tweet this</a></li></ul></div></div></article><div class="box-prev-next clearfix" style="margin-top:10px"><a class="show pull-left" href="/2018/08/28/building-a-simple-single-sign-on-sso-server-and-solution-from-scratch-in-node-js/"><i class="icon icon-angle-left"></i> </a><a class="hide pull-right" href="/"><i class="icon icon-angle-right"></i></a></div></div><a id="backTop" class="back-top"><i class="icon-angle-up"></i></a><div class="modal" id="modal"><span id="cover" class="cover hide"></span><div id="modal-dialog" class="modal-dialog hide-dialog"><div class="modal-header"><span id="close" class="btn-close">Close</span></div><hr><div class="modal-body"><ul class="list-toolbox"><li class="item-toolbox"><a class="CIRCLE" href="https://ankuranand.com" rel="noopener noreferrer" target="_self">About</a></li><li class="item-toolbox"><a class="CIRCLE" href="/atom.xml" rel="noopener noreferrer" target="_blank">RSS</a></li><li class="item-toolbox"><a class="CIRCLE" href="/search/" rel="noopener noreferrer" target="_self">Search</a></li></ul></div></div></div><div class="fexo-comments comments-post"><div id="gitalk-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><script>const gitalk = new Gitalk({
  clientID: 'Infinity',
  clientSecret: '9ac2991775db990e81299dfa99a114395b58de3a',
  repo: 'blog',
  owner: 'ankur-anand',
  id: location.pathname.split('/')[4].substring(0, 45),
  // id: location.pathname,
  admin: ['ankur-anand'],
  labels: ['gicomment'],
  // facebook-like distraction free mode
  distractionFreeMode: false
})
gitalk.render('gitalk-container')</script></div><script type="text/javascript">function loadScript(e,t){var a=document.createElement("script");a.type="text/javascript",a.readyState?a.onreadystatechange=function(){"loaded"!=a.readyState&&"complete"!=a.readyState||(a.onreadystatechange=null,t())}:a.onload=function(){t()},a.src=e,document.getElementsByTagName("head")[0].appendChild(a)}window.onload=function(){loadScript("/js/bundle.js?235683",function(){})}</script><div class="svg-holder"><svg xmlns="https://www.w3.org/2000/svg"><symbol viewbox="0 0 32 32" id="icon-twitter"><title>twitter</title><path d="M31,6.696c-1.103,0.489-2.291,0.82-3.536,0.969c1.271-0.762,2.247-1.968,2.708-3.404c-1.189,0.705-2.508,1.218-3.909,1.493
          c-1.122-1.196-2.723-1.943-4.493-1.943c-3.398,0-6.154,2.755-6.154,6.154c0,0.483,0.055,0.953,0.159,1.402
          C10.66,11.111,6.125,8.66,3.089,4.937C2.561,5.846,2.256,6.902,2.256,8.031c0,2.135,1.086,4.019,2.737,5.123
          c-1.009-0.031-1.957-0.309-2.786-0.77c-0.002,0.025-0.002,0.052-0.002,0.078c0,2.982,2.122,5.469,4.937,6.034
          c-0.517,0.142-1.061,0.217-1.622,0.217c-0.396,0-0.782-0.039-1.158-0.112c0.784,2.444,3.057,4.225,5.75,4.274
          c-2.105,1.651-4.761,2.635-7.645,2.635c-0.496,0-0.985-0.029-1.467-0.086c2.723,1.746,5.958,2.765,9.434,2.765
          c11.321,0,17.512-9.379,17.512-17.512c0-0.268-0.005-0.533-0.018-0.796C29.131,9.014,30.174,7.93,31,6.696L31,6.696z"/></symbol></svg></div><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script></body>